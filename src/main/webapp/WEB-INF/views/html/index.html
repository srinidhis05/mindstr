<html>
<head>
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
</head>
<body>
<style>
    body {
        margin: 0;
    }
    #testcontrols {
        height: 50px;
        overflow-y: scroll;
        padding: 5px;
    }
    #container {
        background-color: #FFFFFF;

        height: calc(100% - 60px);
        width: 100%;
        border: 1px dashed black;
    }

</style>
<div id="testcontrols">
    <input type="button" class="resetView" value="0"></input>
    <input type="button" class="scaleUp" value="+"></input>
    <input type="button" class="scaleDown" value="-"></input>
    <input type="button" class="addSubIdea" value="add"></input>
    <input type="button" onclick="mapModel.insertIntermediateGroup('click', {group:'supporting'})" value="parent reason"></input>
    <input type="button" onclick="mapModel.addGroupSubidea('click', {group:'supporting'})" value="supporting group"></input>
    <input type="button" onclick="mapModel.addGroupSubidea('click', {group:'opposing'})" value="opposing group"></input>
    <input type="button" class="editNode" value="edit"></input>
    <input type="button" class="removeSubIdea" value="delete"></input>
    <input type="button" class="insertIntermediate" value="insert parent"></input>
    <input type="button" class="toggleCollapse" value="exp/col"></input>
    <input type="button" onclick="mapModel.setInputEnabled(false)" value="disable"></input>
    <input type="button" onclick="mapModel.setInputEnabled(true)" value="enable"></input>
    <input type="button" class="undo" value="undo"></input>
    <input type="button" class="redo" value="redo"></input>
    <input type="button" data-mm-action="export-image" value="Export To Image"/>
    <input type="button" class="cut" value="cut"></input>
    <input type="button" class="copy" value="copy"></input>
    <input type="button" class="paste" value="paste"></input>
    <input type="button" class="openAttachment" value="open attachment"></input>
    <input type="button" class="toggleAddLinkMode" value="add link"></input>
    <input type="button" class="insertRoot" value="add root node"></input>
    <input type="button" class="makeSelectedNodeRoot" value="make root"></input>
    Background: <input type="text" class='updateStyle' data-mm-target-property='background'></input>
    Frames: <span id="framerate"></span>
    Cycle: <span id="cyclerate"></span>
    <div id="linkEditWidget">
        <input class="delete" type="button" value="Delete"></input>
        <select class="color">
            <option value="red">Red</option>
            <option value="blue">Blue</option>
        </select>
        <select class="lineStyle">
            <option value="solid">Solid</option>
            <option value="dashed">Dashed</option>
        </select>
        <button class="arrow">Arrow</button>
    </div>
</div>
<div id="container"></div>
<style id="themecss">
</style>
<script>
    jQuery.fn.attachmentEditorWidget = function (mapModel) {
        'use strict';
        return this.each(function () {
            var element = jQuery(this);
            mapModel.addEventListener('attachmentOpened', function (nodeId, attachment) {
                mapModel.setAttachment(
                    'attachmentEditorWidget',
                    nodeId, {
                        contentType: 'text/html',
                        content: prompt('attachment', attachment && attachment.content)
                    }
                );
            });
        });
    };
    (function () {
        window.onerror = alert;
        var container = jQuery('#container'),
            idea = MAPJS.content(test_tree()),
            imageInsertController = new MAPJS.ImageInsertController("http://localhost:4999?u="),
            themeProvider = MAPJS.Themes,
            mapModel = new MAPJS.MapModel(MAPJS.DOMRender.layoutCalculator, []);
        $('#themecss').themeCssWidget(themeProvider, new MAPJS.ThemeProcessor(), mapModel);
        container.domMapWidget(console, mapModel, false, imageInsertController);
        jQuery('body').mapToolbarWidget(mapModel);
        jQuery('body').attachmentEditorWidget(mapModel);
        $("[data-mm-action='export-image']").click(function () {
            MAPJS.pngExport(idea).then(function (url) {
                window.open(url, '_blank');
            });
        });
        mapModel.setIdea(idea);


        jQuery('#linkEditWidget').linkEditWidget();
        window.mapModel = mapModel;
        jQuery('.arrow').click(function () {
        });
        imageInsertController.addEventListener('imageInsertError', function (reason) {
            console.log('image insert error', reason);
        });
        container.on('drop', function (e) {
            var dataTransfer = e.originalEvent.dataTransfer;
            e.stopPropagation();
            e.preventDefault();
            if (dataTransfer && dataTransfer.files && dataTransfer.files.length > 0) {
                var fileInfo = dataTransfer.files[0];
                if (/\.mup$/.test(fileInfo.name)) {
                    var oFReader = new FileReader();
                    oFReader.onload = function (oFREvent) {
                        mapModel.setIdea(MAPJS.content(JSON.parse(oFREvent.target.result)));
                    };
                    oFReader.readAsText(fileInfo, 'UTF-8');
                }
            }
        });
    }());
</script>
</body>
</html>
